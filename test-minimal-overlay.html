<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Overlay Test</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            width: 100%;
            height: 400px;
            position: relative;
        }
        
        canvas {
            width: 100% !important;
            height: 100% !important;
        }
        
        .debug {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Minimal Overlay Test</h1>
        <p>This test verifies that overlay images and text work in HTML exports.</p>
        
        <div class="chart-container">
            <canvas id="chartCanvas"></canvas>
        </div>
        
        <div class="debug">
            <h3>Debug Info:</h3>
            <div id="debug-output"></div>
        </div>
    </div>

    <script>
        // Debug function
        function debug(message) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            output.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        // Sample chart data
        const chartData = {
            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
            datasets: [{
                label: 'Sales',
                data: [25, 35, 20, 40],
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        };

        // Sample overlay images (base64 encoded)
        const overlayImages = [
            {
                id: "test-image-1",
                url: "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzAwNzVmZiIvPjx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VEVTVDwvdGV4dD48L3N2Zz4=",
                x: 100,
                y: 100,
                width: 100,
                height: 100,
                visible: true,
                borderWidth: 2,
                borderColor: "#000000",
                shape: 'rectangle',
                imageFit: 'fill',
                zIndex: 1
            }
        ];

        // Sample overlay texts
        const overlayTexts = [
            {
                id: "test-text-1",
                text: "Test Overlay Text",
                x: 200,
                y: 150,
                fontSize: 16,
                fontFamily: "Arial",
                color: "#333333",
                backgroundColor: "#ffffff",
                backgroundTransparent: false,
                borderWidth: 1,
                borderColor: "#cccccc",
                paddingX: 8,
                paddingY: 4,
                visible: true,
                rotation: 0,
                zIndex: 2
            }
        ];

        debug('Starting overlay test...');
        debug(`Overlay images: ${overlayImages.length}`);
        debug(`Overlay texts: ${overlayTexts.length}`);

        // Simple overlay plugin
        const overlayPlugin = {
            id: 'overlayPlugin',
            
            beforeInit: () => {
                debug('Overlay plugin initialized');
            },
            
            afterDraw(chart) {
                const ctx = chart.ctx;
                const chartArea = chart.chartArea;
                
                debug('Overlay plugin afterDraw called');
                
                // Handle overlay images
                overlayImages.forEach((image) => {
                    if (image.visible) {
                        debug(`Processing image: ${image.id}`);
                        
                        const x = chartArea.left + image.x;
                        const y = chartArea.top + image.y;
                        const w = image.width;
                        const h = image.height;
                        
                        // Create image element
                        const img = new Image();
                        img.onload = () => {
                            debug(`Image loaded: ${image.id}`);
                            ctx.save();
                            ctx.drawImage(img, x, y, w, h);
                            ctx.restore();
                        };
                        img.onerror = () => {
                            debug(`Failed to load image: ${image.id}`);
                        };
                        img.src = image.url;
                    }
                });
                
                // Handle overlay texts
                overlayTexts.forEach((text) => {
                    if (text.visible) {
                        debug(`Drawing text: ${text.id}`);
                        
                        const x = chartArea.left + text.x;
                        const y = chartArea.top + text.y;
                        
                        ctx.save();
                        ctx.font = `${text.fontSize}px ${text.fontFamily}`;
                        ctx.fillStyle = text.color;
                        ctx.fillText(text.text, x, y);
                        ctx.restore();
                    }
                });
            }
        };

        // Register the overlay plugin
        Chart.register(overlayPlugin);
        debug('Overlay plugin registered');

        // Chart configuration
        const chartConfig = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    enabled: true
                },
                legend: {
                    display: true
                },
                overlayPlugin: {
                    overlayImages: overlayImages,
                    overlayTexts: overlayTexts
                }
            }
        };
        
        // Initialize chart
        document.addEventListener('DOMContentLoaded', function() {
            debug('DOM loaded, initializing chart...');
            
            const ctx = document.getElementById('chartCanvas').getContext('2d');
            
            const chart = new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: chartConfig
            });
            
            window.chart = chart;
            debug('Chart initialized successfully!');
        });
        
        // Error handling
        window.addEventListener('error', function(event) {
            debug(`Error: ${event.error.message}`);
            console.error('Chart error:', event.error);
        });
    </script>
</body>
</html> 